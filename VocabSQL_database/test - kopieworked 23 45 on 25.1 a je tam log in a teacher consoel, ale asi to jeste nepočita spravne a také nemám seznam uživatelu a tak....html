<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/language-selector.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1BCW5XQ0X5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1BCW5XQ0X5');
    </script>
    <title>Test Vocabulary - H√°Czech</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <style>
        .test-box { background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 20px; margin: 20px auto; text-align: center; border: 2px solid #2c3e50; width: 90%; max-width: 500px; height: 600px; position: relative; display: flex; flex-direction: column; }
        #image-container { height: 200px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .display-eng { font-size: 1.5rem; color: #555; transition: all 0.3s ease; }
        .display-czech { font-size: 2.5rem; font-weight: bold; color: #d32f2f; margin: 15px 0; min-height: 60px; }
        .no-image-text { font-size: 3rem; color: #2c3e50; font-weight: bold; margin-top: -100px; }
        .no-image-czech { font-size: 3.5rem; }
        #btn-container, #reveal-next { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; }
        .test-btn { padding: 10px 25px; font-size: 1rem; cursor: pointer; border-radius: 5px; border: none; background: #2c3e50; color: white; margin: 5px; }
        .hidden { visibility: hidden; }
        #word-guess-box { padding: 12px; font-size: 1.2rem; width: 80%; border-radius: 8px; border: 2px solid #ddd; margin: 15px auto; outline: none; }
        #success-msg { color: #27ae60; font-weight: bold; font-size: 1.8rem; height: 40px; margin-top: 10px; }
        .typo-warning { color: #f39c12; font-weight: bold; height: 20px; margin-bottom: 10px; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .auth-card { background: white; padding: 30px; border-radius: 15px; width: 320px; text-align: center; }
        .auth-card input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        #unpaid-message { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        
        /* Modal Styles */
        .modal-content { background:white; max-width:800px; margin:40px auto; padding:20px; border-radius:12px; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #user-table { width:100%; border-collapse: collapse; margin-top: 10px; }
        #user-table th, #user-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    </style>
</head>
<body class="home">

<div id="auth-overlay">
    <div class="auth-card">
        <h2 id="auth-title">Log In</h2>
        <div id="signup-fields" style="display:none;"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-pass" placeholder="Password">
        <button class="test-btn" style="width:100%; margin-top:10px;" onclick="handleAuth()">Confirm</button>
        <p style="margin-top:15px; font-size:0.8rem;">
            <span id="toggle-link" style="color:#3498db; cursor:pointer;" onclick="toggleAuth()">Need an account? Sign Up</span><br><br>
            <span style="color:#e67e22; cursor:pointer;" onclick="forgotPassword()">Forgot Password?</span>
        </p>
    </div>
</div>

<div id="unpaid-message">
    <h1 style="color: #e74c3c;">Subscription Required</h1>
    <p>Please contact your teacher to activate your account.</p>
    <button class="test-btn" onclick="signOutUser()">Sign Out</button>
</div>

<button id="admin-trigger" class="test-btn" style="display:none; position: fixed; top: 10px; left: 10px; z-index: 999; background: #e67e22;" onclick="openAdmin()">Teacher Console</button>

<header>
    <h1 id="heading-welcome">Vocabulary Tester</h1>
    <div id="language-selector-container"></div>
</header>

<main>
    <div class="test-box">
        <div style="margin-bottom: 15px;">
            <select id="level-select" style="padding: 5px;" onchange="getRandomWord()">
                <option value="A1">A1</option>
                <option value="A2">A2</option>
            </select>
        </div>
        <div id="image-container">
            <img id="word-image" src="" style="max-height: 100%; border-radius: 8px; display: none;">
        </div>
        <div id="english-word" class="display-eng">---</div>
        <div id="success-msg"></div>
        <div id="typo-msg" class="typo-warning"></div>
       
<input type="text" style="position: absolute; opacity: 0; height: 0; width: 0; z-index: -1;" name="trap">
<input type="text" id="word-guess-box" name="czech_tester_unique" placeholder="Type in Czech..." autocomplete="new-password" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter') evaluateTyping()">


        <div id="czech-word" class="display-czech hidden">---</div>
        <div id="btn-container">
            <button class="test-btn" style="background:#27ae60;" onclick="updateWeight('yes')">YES</button>
            <button class="test-btn" onclick="getRandomWord()">NEXT</button>
            <button class="test-btn" style="background:#e74c3c;" onclick="updateWeight('no')">NO</button>
        </div>
        <button id="reveal-next" class="test-btn" style="display:none; width:80%; margin: 0 auto;" onclick="getRandomWord()">NEXT WORD</button>
    </div>

<nav style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin-top: 20px; gap: 10px;">
    <button class="test-btn" 
            style="background:#7f8c8d; font-size: 0.8rem; width: 120px !important; padding: 8px 10px; margin: 0 !important; display: block;" 
            onclick="signOutUser()">Sign Out</button>

    <a href="../index.html" 
       style="text-decoration:none; color: #2c3e50; font-weight: bold; font-size: 1rem; margin: 0 !important; display: block; text-align: center;">üè† Main Page</a>
</nav>

</main>

<div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10001; overflow-y:auto;">
    <div class="modal-content">
        <span style="position:absolute; right:20px; top:10px; cursor:pointer; font-size:2rem;" onclick="closeAdmin()">&times;</span>
        <h2>Teacher Console</h2>
        <input type="text" id="user-search" placeholder="Search by name or email..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;" onkeyup="filterUsers()">
        <table id="user-table">
            <thead style="background:#eee;">
                <tr><th>Name</th><th>Email</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody id="user-tbody"></tbody>
        </table>
        <div id="report-section" style="display:none; margin-top:30px; border-top:2px solid #eee; padding-top:20px;">
            <button class="test-btn" style="float:right; background:#7f8c8d;" onclick="document.getElementById('report-section').style.display='none'">Close Report</button>
            <h3 id="report-title">Student Progress</h3>
            <canvas id="adminProgressChart" style="width:100%; height:300px;"></canvas>
        </div>
    </div>
</div>

<div id="footer-placeholder"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAGCKtAQkj9bsrSpJ1IQWLAm_PA20vTluM",
        authDomain: "vocabsql-database.firebaseapp.com",
        databaseURL: "https://vocabsql-database-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "vocabsql-database",
        storageBucket: "vocabsql-database.firebasestorage.app",
        messagingSenderId: "122357206206",
        appId: "1:122357206206:web:bc6a3b03e4f87c910ae2ef"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const dbRef = firebase.database();
    
    let db, currentWord, userWeights = {}, isSignUp = false, allUsers = {}, myChart;



// --- FINAL KEYBOARD SHORTCUTS (FIXED ARROWS & NO HINTS) ---
// --- FINAL KEYBOARD SHORTCUTS (KILLS ALL HINTS/EMAILS) ---
document.addEventListener('keydown', function(event) {
    // 1. Exit if Admin Modal or Auth is open
    const isAdminOpen = document.getElementById('admin-modal').style.display === 'block';
    const isAuthOpen = document.getElementById('auth-overlay').style.display !== 'none';
    if (isAdminOpen || isAuthOpen) return;

    // 2. Allow normal typing if searching for users
    if (event.target.id === 'user-search') return;

    // 3. Handle Arrow Keys
    if (event.key === 'ArrowUp' || event.key === 'ArrowDown' || event.key === 'ArrowRight') {
        
        // This stops the browser from opening the email/autocomplete menu
        event.preventDefault(); 
        event.stopPropagation();

        const isRevealNextVisible = document.getElementById('reveal-next').style.display === 'block';

        if (isRevealNextVisible) {
            if (event.key === 'ArrowRight' || event.key === 'Enter') {
                getRandomWord();
            }
        } else {
            if (event.key === 'ArrowUp') { 
                updateWeight('yes'); 
            }
            else if (event.key === 'ArrowDown') { 
                updateWeight('no'); 
            }
            else if (event.key === 'ArrowRight') { 
                getRandomWord(); 
            }
        }
    }
}, true); // The "true" ensures your code handles the key before the browser's autofill logic


    // --- AUTH LOGIC ---
    auth.onAuthStateChanged(user => {
        if(user) {
            // Check if Admin
            if(user.email === 'lukas@hackczech.com') {
                document.getElementById('admin-trigger').style.display = 'block';
                loadUsers();
            }
            // Load User Data
            dbRef.ref('users/'+user.uid).on('value', snap => {
                const d = snap.val();
                if(d && d.status === 'paid') {
                    userWeights = d.weights || {};
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('unpaid-message').style.display = 'none';
                    if(!db) initDatabase();
                } else {
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('unpaid-message').style.display = 'flex';
                }
            });
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    async function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            if (isSignUp) {
                const c = await auth.createUserWithEmailAndPassword(email, pass);
                await dbRef.ref('users/'+c.user.uid).set({name: document.getElementById('reg-name').value, email, status:'pending'});
                alert("Account created. Please ask teacher for approval.");
            } else { await auth.signInWithEmailAndPassword(email, pass); }
        } catch(e) { alert(e.message); }
    }

    function toggleAuth() {
        isSignUp = !isSignUp;
        document.getElementById('auth-title').innerText = isSignUp ? "Sign Up" : "Log In";
        document.getElementById('signup-fields').style.display = isSignUp ? 'block' : 'none';
        document.getElementById('toggle-link').innerText = isSignUp ? "Already have an account? Log In" : "Need an account? Sign Up";
    }
    
    function forgotPassword() {
        const email = document.getElementById('auth-email').value;
        if(!email) return alert("Enter email first.");
        auth.sendPasswordResetEmail(email).then(()=>alert("Reset sent!")).catch(e=>alert(e.message));
    }

    function signOutUser() { auth.signOut().then(() => location.reload()); }

    // --- ADMIN LOGIC ---
    function openAdmin() { document.getElementById('admin-modal').style.display = 'block'; }
    function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }

    function loadUsers() {
        dbRef.ref('users').on('value', snap => {
            allUsers = snap.val() || {};
            renderUserTable(allUsers);
        });
    }

    function renderUserTable(data) {
        const tbody = document.getElementById('user-tbody');
        tbody.innerHTML = '';
        for(let id in data) {
            let u = data[id];
            let row = `<tr>
                <td>${u.name}</td>
                <td>${u.email}</td>
                <td>${u.status}</td>
                <td>
                    <button onclick="updateStatus('${id}', '${u.status === 'paid' ? 'pending' : 'paid'}')">Toggle Status</button>
                    <button style="background:#3498db; color:white;" onclick="showReport('${id}', '${u.name}')">Report</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        }
    }

    function filterUsers() {
        const term = document.getElementById('user-search').value.toLowerCase();
        const filtered = {};
        for(let id in allUsers) {
            if(allUsers[id].name.toLowerCase().includes(term) || allUsers[id].email.toLowerCase().includes(term)) {
                filtered[id] = allUsers[id];
            }
        }
        renderUserTable(filtered);
    }

    function updateStatus(uid, status) {
        dbRef.ref('users/' + uid).update({status: status});
    }

    function showReport(uid, name) {
        dbRef.ref('users/' + uid + '/weights').once('value', snap => {
            const weights = snap.val() || {};
            document.getElementById('report-section').style.display = 'block';
            document.getElementById('report-title').innerText = "Progress: " + name;
            
            const ctx = document.getElementById('adminProgressChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(weights),
                    datasets: [{ label: 'Difficulty', data: Object.values(weights), backgroundColor: '#2c3e50' }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
            });
            document.getElementById('report-section').scrollIntoView();
        });
    }

    // --- GAME LOGIC ---
    async function initDatabase() {
        try {
            const sqlPromise = initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
            const response = await fetch("czech_master.db");
            const buf = await response.arrayBuffer();
            const [SQL, data] = await Promise.all([sqlPromise, buf]);
            db = new SQL.Database(new Uint8Array(data));
            getRandomWord();
        } catch (err) { console.error(err); }
    }

function getRandomWord() {
    if(!db) return;
    document.getElementById('btn-container').style.display = 'flex';
    document.getElementById('reveal-next').style.display = 'none';
    document.getElementById('czech-word').classList.add('hidden');
    
    // UPDATE THESE TWO LINES:
    document.getElementById('word-guess-box').value = ""; 
    document.getElementById('word-guess-box').focus();

    document.getElementById('typo-msg').innerText = "";
    document.getElementById('success-msg').innerText = "";

        const level = document.getElementById('level-select').value;
        const res = db.exec(`SELECT lemma, trans_en, image_path, audio_path FROM words WHERE level='${level}'`);
        if(res[0]) {
            const rows = res[0].values;
            let pool = [];
            rows.forEach(r => {
                const w = userWeights[r[0]] || 5;
                for(let i=0; i<w; i++) pool.push(r);
            });
            const s = pool[Math.floor(Math.random()*pool.length)];
            currentWord = { czech: s[0], english: s[1], img: s[2], audio: s[3] };
            document.getElementById('english-word').innerText = s[1];
            document.getElementById('czech-word').innerText = s[0];
            const img = document.getElementById('word-image');
            if(s[2]) { img.src = s[2]; img.style.display = 'block'; } else { img.style.display = 'none'; }
        }
        document.getElementById('word-guess-box').focus();
    }

    function evaluateTyping() {
    const input = document.getElementById('word-guess-box').value.trim().toLowerCase();
    const target = currentWord.czech.toLowerCase();
        if (input === target) {
            document.getElementById('success-msg').innerText = "Spr√°vnƒõ!";
            document.getElementById('czech-word').classList.remove('hidden');
            adjustWeight(-1);
            setTimeout(getRandomWord, 1200);
        } else {
            document.getElementById('typo-msg').innerText = "Not quite...";
            showAnswer(2);
        }
    }

    function showAnswer(penalty) {
        document.getElementById('czech-word').classList.remove('hidden');
        document.getElementById('btn-container').style.display = 'none';
        document.getElementById('reveal-next').style.display = 'block';
        if(currentWord.audio) new Audio(currentWord.audio).play().catch(()=>{});
        adjustWeight(penalty);
    }

    function updateWeight(choice) {
        if(choice === 'yes') {
            document.getElementById('success-msg').innerText = "Spr√°vnƒõ!";
            document.getElementById('czech-word').classList.remove('hidden');
            adjustWeight(-1);
            setTimeout(getRandomWord, 1200);
        } else showAnswer(2);
    }

    function adjustWeight(change) {
        let w = userWeights[currentWord.czech] || 5;
        userWeights[currentWord.czech] = Math.max(1, w + change);
        dbRef.ref('users/'+auth.currentUser.uid+'/weights').set(userWeights);
    }

    // Levenshtein and Keyboard logic removed for brevity but keep them in your actual file!
    fetch("../footer.html").then(r => r.text()).then(d => { document.getElementById("footer-placeholder").innerHTML = d; });





</script>
</body>
</html>