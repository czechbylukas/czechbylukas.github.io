<!DOCTYPE html>
<html lang="cs">
<head>
        
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script> <script src="../scripts-header.js"></script>

    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/language-selector.css">
    <title id="page-title">Study Tool | H√°CZech</title>


    <style>
        .test-box { background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 20px; margin: 20px auto; text-align: center; border: 2px solid #2c3e50; width: 90%; max-width: 500px; height: 550px; position: relative; display: flex; flex-direction: column; }
        #image-container { height: 200px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .display-eng { font-size: 1.5rem; color: #555; transition: all 0.3s ease; }
        .display-czech { font-size: 2.5rem; font-weight: bold; color: #d32f2f; margin: 15px 0; min-height: 60px; }
        .no-image-text { font-size: 3rem; color: #2c3e50; font-weight: bold; margin-top: -100px; }
        .no-image-czech { font-size: 3.5rem; }
        #btn-container, #reveal-next { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; }
        .test-btn { padding: 10px 25px; font-size: 1rem; cursor: pointer; border-radius: 5px; border: none; background: #2c3e50; color: white; margin: 5px; }
        .hidden { visibility: hidden; }
        #word-guess-box { padding: 12px; font-size: 1.2rem; width: 80%; border-radius: 8px; border: 2px solid #ddd; margin: 15px auto; outline: none; }
        #success-msg { color: #27ae60; font-weight: bold; font-size: 1.8rem; height: 40px; margin-top: 10px; }
        .typo-warning { color: #f39c12; font-weight: bold; height: 20px; margin-bottom: 10px; }






    </style>
</head>
<body class="home">

<div id="auth-overlay">
    <div class="auth-card">
        <h2 id="auth-title">Log In</h2>
        <div id="signup-fields" style="display:none;"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-pass" placeholder="Password">
        <button class="test-btn" style="width:100%; margin-top:10px;" onclick="handleAuth()">Confirm</button>
        <p style="margin-top:15px; font-size:0.8rem;">
            <span id="toggle-link" style="color:#3498db; cursor:pointer;" onclick="toggleAuth()">Need an account? Sign Up</span><br><br>
            <span style="color:#e67e22; cursor:pointer;" onclick="forgotPassword()">Forgot Password?</span>
        </p>
    </div>
</div>

<div id="unpaid-message">
    <h1 style="color: #e74c3c;">Premium Lesson</h1>
    <p>This section is included in your full subscription.</p>
    <p style="margin-bottom: 20px;">Please contact your teacher to activate your account.</p>
    
    <div style="display: flex; gap: 10px; flex-direction: column;">
        <button class="test-btn" style="background: #27ae60;" onclick="location.reload()">
            Back to Free Lesson
        </button>

    </div>
</div>

<header style="display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: white; border-bottom: 2px solid #2c3e50;">



    <div style="flex: 1; text-align: center;">
        <h1 id="heading-welcome" style="margin: 0; font-size: 1.5rem;">Study Tool</h1>
    </div>

    <div style="flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
        <div class="lang-switcher">
            <select id="ui-lang-select" onchange="localStorage.setItem('selectedLanguage', this.value); location.reload();" style="padding: 5px; border-radius: 5px; cursor: pointer;">
                <option value="en">üá¨üáß English</option>
                <option value="de">üá©üá™ Deutsch</option>
                <option value="es">üá™üá∏ Espa√±ol</option>
            </select>
        </div>
        <div id="auth-status-container" style="min-width: 40px; display: flex; justify-content: center;"></div>
    </div>

</header>


<aside id="sidebar-placeholder"></aside>



<main style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding: 20px;">
    <aside id="study-filters" style="width: 250px; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 12px; border: 2px solid #2c3e50; height: fit-content;">
        <h3 style="margin-top:0;">Filters (Optional)</h3>
        
        <label>Lesson:</label>
        <select id="level-select" style="padding: 8px; width: 100%; margin-bottom: 15px; border-radius: 5px;" onchange="getRandomWord()">
            <option disabled selected>Vyberte sadu...</option>
        </select>

        <label>Word Type:</label>
        <select id="pos-select" style="padding: 8px; width: 100%; margin-bottom: 15px; border-radius: 5px;" onchange="getRandomWord()">
            <option value="all">All Types</option>
        </select>

        <label>Category:</label>
        <select id="category-select" style="padding: 8px; width: 100%; margin-bottom: 15px; border-radius: 5px;" onchange="getRandomWord()">
            <option value="all">All Categories</option>
        </select>



<div id="char-picker" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; color: #2c3e50;">
    <script>
        ['≈æ','≈°','ƒç','≈ô','ƒè','≈•','≈à','ƒõ','√°','√©','√≠','√Ω','√≥','√∫','≈Ø'].forEach(char => {
            document.write(`<span onclick="insertChar('${char}')" style="cursor:pointer; padding: 5px 8px; background: #eee; border-radius: 4px; font-weight: bold; border: 1px solid #ccc;">${char}</span>`);
        });


// ADD THIS TO THE BOTTOM OF YOUR SCRIPT SECTION
function insertChar(char) {
    const input = document.getElementById('word-guess-box');
    const start = input.selectionStart;
    const end = input.selectionEnd;
    input.setRangeText(char, start, end, 'end');
    input.focus();
}
    </script>
</div>





    </aside>

    <div class="test-box" style="margin: 0;">





        
        <div id="image-container">
            <img id="word-image" src="" style="max-height: 100%; border-radius: 8px; display: none;">
        </div>
        <div id="english-word" class="display-eng">
    üëà select from the filters to start!<br>
          A0 is a free tier.
</div>
        <div id="success-msg"></div>
        <div id="typo-msg" class="typo-warning"></div>
       
<input type="text" style="position: absolute; opacity: 0; height: 0; width: 0; z-index: -1;" name="trap">
<input type="text" id="word-guess-box" name="czech_tester_unique" placeholder="Type in Czech..." autocomplete="new-password" autocorrect="off" spellcheck="false" onkeydown="if(event.key==='Enter') evaluateTyping()">


        <div id="czech-word" class="display-czech hidden"></div>
        <div id="btn-container">
            <button class="test-btn" style="background:#27ae60;" onclick="updateWeight('yes')">UM√çM</button>
            <button class="test-btn" style="background:#e74c3c;" onclick="updateWeight('no')">NEUM√çM</button>
        </div>
        <button id="reveal-next" class="test-btn" style="display:none; width:80%; margin: 0 auto;" onclick="getRandomWord()">NEXT WORD</button>
    </div>

<nav style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; margin-top: 20px; gap: 10px;">


    <a href="../index.html" 
       style="text-decoration:none; color: #2c3e50; font-weight: bold; font-size: 1rem; margin: 0 !important; display: block; text-align: center;">üè† Main Page</a>
</nav>

</main>






<div id="ad-wrapper" style="text-align: center; margin: 15px 0; min-height: 90px; display: none;">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-9067674021614925"
         data-ad-slot="6031820485" 
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
</div>




<div id="footer-placeholder"></div>

<script>
// Just link to the ones already created by scripts-header.js
const auth = firebase.auth();
const dbRef = firebase.database();
    
    let db, currentWord, userWeights = {}, isSignUp = false;

window.userStatus = 'guest';

// --- FINAL KEYBOARD SHORTCUTS (KILLS ALL HINTS/EMAILS) ---
document.addEventListener('keydown', function(event) {
    // 1. Exit if Admin Modal or Auth is open
    // Only check for Auth, since Admin is gone
const isAuthOpen = document.getElementById('auth-overlay').style.display !== 'none';
if (isAuthOpen) return;

// 2. Allow normal typing if searching for users OR focused on the guess box
if (event.target.id === 'user-search' || event.target.id === 'word-guess-box') return;

// 3. Handle Arrow Keys
if (event.key === 'ArrowUp' || event.key === 'ArrowDown' || event.key === 'ArrowRight') {



        // This stops the browser from opening the email/autocomplete menu
        event.preventDefault(); 
        event.stopPropagation();

        const isRevealNextVisible = document.getElementById('reveal-next').style.display === 'block';

        if (isRevealNextVisible) {
            if (event.key === 'ArrowRight' || event.key === 'Enter') {
                getRandomWord();
            }
        } else {
            if (event.key === 'ArrowUp') { 
                updateWeight('yes'); 
            }
            else if (event.key === 'ArrowDown') { 
                updateWeight('no'); 
            }
            else if (event.key === 'ArrowRight') { 
                getRandomWord(); 
            }
        }
    }
}, true); // The "true" ensures your code handles the key before the browser's autofill logic





    // --- AUTH LOGIC ---
auth.onAuthStateChanged(user => {
    // 1. Let the global script handle the icon/overlay
    if (typeof applyAccessControl === 'function') {
        applyAccessControl(user); 
    }

    if(user) {
        // 2. Only handle Data and Admin access here
        dbRef.ref('users/' + user.uid).on('value', snap => {
            const userData = snap.val();
            if (userData) {
                window.userStatus = userData.status;
                userWeights = userData.weights || {};
            }
        document.getElementById('auth-overlay').style.display = 'none';
if (window.userStatus !== 'paid') {
    document.getElementById('ad-wrapper').style.display = 'block';
    loadAdsSafely();
}

        });
}
        // 3. Show Teacher Console only for you

});











    // --- GAME LOGIC ---
    // GET LEVELS FROM DATABASE COLUMD D
async function initDatabase() {
    // FIX: Set the dropdown value to match saved language
    // Polished version
        let savedLang = localStorage.getItem("selectedLanguage") || "en";
        if (savedLang === "cs") savedLang = "en"; // Force UI to show English
document.getElementById('ui-lang-select').value = savedLang;
    try {
        const sqlPromise = initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
	    const response = await fetch("czech_master.db");        
	    const buf = await response.arrayBuffer();
        const [SQL, data] = await Promise.all([sqlPromise, buf]);
        db = new SQL.Database(new Uint8Array(data));

// 1. Populate Lesson Select
        const res = db.exec("SELECT DISTINCT level, lesson FROM words WHERE level IS NOT NULL AND level != '' AND lesson IS NOT NULL AND lesson != ''");
        const select = document.getElementById('level-select');
        select.innerHTML = '<option disabled selected>Vyberte sadu...</option>'; 

        if (res[0]) {
            const sortedRows = res[0].values.sort((a, b) => {
    // Treat NULL or empty values as an empty string "" so localeCompare doesn't crash
    // 1. Sort the valid data from the database
    if (a[0] !== b[0]) return a[0].localeCompare(b[0]);
    return parseInt(a[1]) - parseInt(b[1]) || a[1].localeCompare(b[1]);
});

let uniqueLevels = new Set(); 
let currentGroup = null;
let groupElement = null;

// 2. Build the dropdown
sortedRows.forEach(row => {
    const levelVal = row[0]; // Define FIRST
    const lessonVal = row[1]; // Define FIRST
    uniqueLevels.add(levelVal); // Now use it
    if (levelVal !== currentGroup) {
        currentGroup = levelVal;
        groupElement = document.createElement('optgroup');
        groupElement.label = `Level ${levelVal}`;
        select.appendChild(groupElement);
    }
    
    const opt = document.createElement('option');
    opt.value = `${levelVal}|${lessonVal}`;
    // Removes the prefix (e.g., "01 ") from the lesson name for display
    opt.innerText = lessonVal.substring(3); 
    groupElement.appendChild(opt);
});

            // ADD "ALL LEVEL" OPTIONS AT THE VERY BOTTOM
            const allGroup = document.createElement('optgroup');
            allGroup.label = "Cel√© √∫rovnƒõ (Full Levels)";
            select.appendChild(allGroup);

            Array.from(uniqueLevels).sort().forEach(lvl => {
                const opt = document.createElement('option');
                opt.value = `${lvl}|ALL_LESSONS`;
                opt.innerText = `V≈°e z √∫rovnƒõ ${lvl}`;
                allGroup.appendChild(opt);
            });
        }

        // 2. DYNAMICALLY POPULATE POS (Column C)
        const posRes = db.exec("SELECT DISTINCT pos FROM words WHERE pos IS NOT NULL AND pos != ''");
        if(posRes[0]) {
            const posSelect = document.getElementById('pos-select');
            let optionsHtml = '<option value="all">All Types</option>'; 
            posRes[0].values.sort().forEach(row => {
                const val = row[0];
                if (val.toLowerCase() === 'verb') {
                    optionsHtml += `<option value="verb|filtered">verb</option>`;
                    optionsHtml += `<option value="verb">verb with vid (Grammatical aspect)</option>`;
                } else {
                    optionsHtml += `<option value="${val}">${val}</option>`;
                }
            });
            posSelect.innerHTML = optionsHtml;
        }

// --- DYNAMICALLY LOAD CATEGORY (COLUMN K) ---
        const catRes = db.exec("SELECT DISTINCT category FROM words WHERE category IS NOT NULL AND category != '' AND category != 'TBD' ORDER BY category ASC");
        if(catRes[0]) {
            const catSelect = document.getElementById('category-select');
            catRes[0].values.sort().forEach(row => {
                catSelect.innerHTML += `<option value="${row[0]}">${row[0]}</option>`;
            });
        }

    } catch (err) { 
        console.error("Database Error:", err); 
    }
}





function getRandomWord() {
    if(!db) return;
    
    const combinedValue = document.getElementById('level-select').value;
    
    // Get the language, but if it's 'cs', treat it as 'en'
    let currentLang = localStorage.getItem("selectedLanguage") || "en";
    if (currentLang === "cs") currentLang = "en"; 

    const langColumn = "trans_" + currentLang;

// IF NO LESSON IS SELECTED
    if(!combinedValue || combinedValue.includes("Vyberte")) {
        document.getElementById('english-word').innerText = "üëà select from the filters to start!";
        document.getElementById('btn-container').style.display = 'none'; 
        document.getElementById('word-guess-box').style.display = 'none'; // Hide the input box too
        return;
    } else {
        // Show the input box once they pick a lesson
        document.getElementById('word-guess-box').style.display = 'block';
    }

    const [level, lesson] = combinedValue.split('|');

    // 1. UI RESET
    document.getElementById('english-word').innerText = "";
    document.getElementById('czech-word').innerText = "";
    document.getElementById('word-image').style.display = 'none';
    document.getElementById('typo-msg').innerText = "";
    document.getElementById('success-msg').innerText = "";
    document.getElementById('word-guess-box').value = ""; 
    document.getElementById('czech-word').classList.add('hidden');
    document.getElementById('btn-container').style.display = 'flex';
    document.getElementById('reveal-next').style.display = 'none';

    // 2. Permission Check
    const isFreeLesson = (level === 'A0' && (lesson === '00 U≈æiteƒçn√° slova' || lesson === '00 Essentials'));
    const isUserPaid = (window.userStatus === 'paid');

    if (!isFreeLesson && !isUserPaid) {
        if (window.userStatus === 'guest') {
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('auth-title').innerText = "Sign in for this lesson";
        } else {
            document.getElementById('unpaid-message').style.display = 'flex';
        }
        return; 
    }

    // 3. Build Query
    const posVal = document.getElementById('pos-select').value;
    const catVal = document.getElementById('category-select').value;
    let filterClause = "";
    
    // Replace your current posVal logic with this:
if (posVal !== "all") {
    if (posVal === "verb|filtered" || posVal === "verb") {
        filterClause += " AND (LOWER(pos) = 'verb')";
    } else {
        filterClause += ` AND pos = '${posVal}'`;
    }
}

    if (catVal !== "all") filterClause += ` AND category = '${catVal}'`;
    let lessonClause = (lesson === "ALL_LESSONS") ? "" : `AND lesson='${lesson}'`;

    // Change the SELECT to include 'vid_pair' (Column M)
const query = `SELECT lemma, ${langColumn}, image_path, audio_path, synonym, vid_pair 
               FROM words 
               WHERE level='${level}' ${lessonClause} ${filterClause}`;

    console.log("Running SQL:", query); // DEBUG: Look at your browser console (F12) to see the actual query
    const res = db.exec(query);



    // 4. Selection Logic
    if(res[0] && res[0].values.length > 0) {
        const rows = res[0].values;
        let pool = [];
        
        // Fill pool based on weights
        rows.forEach(r => {
            const safeKey = r[0].replace(/[.#$[\]/]/g, "_"); 
        const w = userWeights[safeKey] || 5;
        for(let i=0; i<w; i++) pool.push(r);
    });
        
        // Pick random word from pool
        const s = pool[Math.floor(Math.random() * pool.length)];
currentWord = { 
    czech: s[0], 
    translation: s[1], 
    img: s[2], 
    audio: s[3], 
    synonym: s[4],
    vidPair: s[5] // This stores the value from Column M
};
        
        document.getElementById('english-word').innerText = s[1];
        
        // Show synonym if it exists
        const displayWord = currentWord.synonym ? `${s[0]} / ${s[4]}` : s[0];
        document.getElementById('czech-word').innerText = displayWord;
        
        const img = document.getElementById('word-image');
        if(s[2]) { 
            img.src = s[2]; 
            img.style.display = 'block'; 
        } else { 
            img.style.display = 'none'; 
        }
    } else {
        document.getElementById('english-word').innerText = "No words found for this filter.";
    }
    document.getElementById('word-guess-box').focus();
}





function recordMistake(czechWord) {
    const user = auth.currentUser;
    if (!user || window.userStatus !== 'paid') return;

    // Sanitize the word for Firebase (no dots or slashes allowed in keys)
    const safeWord = czechWord.replace(/[.#$[\]/]/g, "_");

    // Increment mistake count in users/UID/mistakes/Word
    const ref = dbRef.ref(`users/${user.uid}/mistakes/${safeWord}`);
    ref.transaction((currentValue) => {
        return (currentValue || 0) + 1;
    });
}







function evaluateTyping() {
    const input = document.getElementById('word-guess-box').value.trim().toLowerCase();
    if (!input) return;

    const lemma = currentWord.czech.toLowerCase();
    const synonym = currentWord.synonym ? currentWord.synonym.toLowerCase() : null;
    const vPair = currentWord.vidPair ? currentWord.vidPair.toLowerCase() : null;

    // Create a list of all acceptable answers
    let acceptableAnswers = [lemma];
    if (synonym) acceptableAnswers.push(synonym);
    
    if (vPair) {
        acceptableAnswers.push(vPair);
        // Add combinations: "lemma/vPair" and "vPair/lemma"
        acceptableAnswers.push(`${lemma}/${vPair}`);
        acceptableAnswers.push(`${vPair}/${lemma}`);
        // Add versions with spaces: "lemma / vPair"
        acceptableAnswers.push(`${lemma} / ${vPair}`);
        acceptableAnswers.push(`${vPair} / ${lemma}`);
    }

    // Check for a perfect match in any of the acceptable answers
    const isCorrect = acceptableAnswers.some(ans => input === ans);

    if (isCorrect) {
        document.getElementById('success-msg').innerText = "V√Ωbornƒõ!";
        showAnswerInUI();
        adjustWeight(-1);
        setTimeout(getRandomWord, 1200);
    } else {
        // Check for typos (Levensthein distance)
        const hasTypo = acceptableAnswers.some(ans => getEditDistance(input, ans) <= (ans.length > 5 ? 2 : 1));
        
        if (hasTypo) {
            document.getElementById('typo-msg').innerText = "T√©mƒõ≈ô! Pod√≠vejte se na spr√°vn√Ω tvar.";
            showAnswer(0);
        } else {
            document.getElementById('typo-msg').innerText = "Bohu≈æel...";
            recordMistake(currentWord.czech);
            showAnswer(1);
        }
    }
}

// Helper to show the full answer (Lemma + Pair)
function showAnswerInUI() {
    let display = currentWord.czech;
    if (currentWord.vidPair) display += ` / ${currentWord.vidPair}`;
    if (currentWord.synonym) display += ` (${currentWord.synonym})`;
    
    document.getElementById('czech-word').innerText = display;
    document.getElementById('czech-word').classList.remove('hidden');
}





   function showAnswer(penalty) {
    showAnswerInUI(); // Uses the new helper above
    document.getElementById('btn-container').style.display = 'none';
    document.getElementById('reveal-next').style.display = 'block';
    if(currentWord.audio) new Audio(currentWord.audio).play().catch(()=>{});
    adjustWeight(penalty);
}



function updateWeight(choice) {
    const inputField = document.getElementById('word-guess-box');
    const hasTyped = inputField.value.trim().length > 0;

    if (choice === 'yes') {
        // If they clicked "UM√çM" but actually typed something
        if (hasTyped) {
            evaluateTyping(); // This will check if their typing is correct
        } else {
            // Standard "I knew it" behavior (empty box)
            document.getElementById('success-msg').innerText = "Spr√°vnƒõ!";
            showAnswerInUI();
            adjustWeight(-1);
            setTimeout(getRandomWord, 1200);
        }
    } else {
        // choice === 'no'
        recordMistake(currentWord.czech);
        showAnswer(1);
    }
}

function adjustWeight(change) {
    if(window.userStatus !== 'paid' || !auth.currentUser) return; 
    
    const safeKey = currentWord.czech.replace(/[.#$[\]/]/g, "_");
    
    let w = userWeights[safeKey] || 5;
    userWeights[safeKey] = Math.max(1, w + change);
    dbRef.ref('users/'+auth.currentUser.uid+'/weights').set(userWeights);
}



// Levenshtein and Keyboard logic removed for brevity but keep them in your actual file!
fetch("/sidebar/sidebar.html").then(r => r.text()).then(d => { document.getElementById("sidebar-placeholder").innerHTML = d; }).catch(err => console.error("Sidebar load failed"));
fetch("../footer.html").then(r => r.text()).then(d => { document.getElementById("footer-placeholder").innerHTML = d; });



// DONT BE STRICT IF THE ANSWER HAS TYPO
function getEditDistance(a, b) {
    if (a.length === 0) return b.length;
    if (b.length === 0) return a.length;
    const matrix = [];
    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i - 1) === a.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
            }
        }
    }
    return matrix[b.length][a.length];
}


function loadAdsSafely() {
    if (window.location.hostname === 'localhost') return;
    try {
        if (document.getElementById('ad-wrapper').style.display !== 'none') {
            (adsbygoogle = window.adsbygoogle || []).push({});
        }
    } catch (e) { console.error("Ads blocked"); }
}


initDatabase();

</script>
</body>
</html>