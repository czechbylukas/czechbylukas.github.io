<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/language-selector.css">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1BCW5XQ0X5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1BCW5XQ0X5');
    </script>

    <title>Test Vocabulary - H√°Czech</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

    <style>
        .test-box {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #2c3e50;
        }
        .display-czech { font-size: 2.5rem; font-weight: bold; color: #d32f2f; margin: 15px 0; }
        .display-eng { font-size: 1.5rem; color: #555; height: 30px; margin-bottom: 20px; }
        .test-btn { 
            padding: 10px 25px; font-size: 1rem; cursor: pointer; border-radius: 5px; border: none; 
            background: #2c3e50; color: white; margin: 5px;
        }
        .hidden { visibility: hidden; }
    </style>
</head>
<body class="home">

<header>
    <h1 id="heading-welcome">Vocabulary Tester</h1>
    <div id="language-selector-container"></div>
</header>

<main>
    <p id="heading-mainPageText">Practicing your learned vocabulary.</p>

    <div class="test-box">
        <div style="margin-bottom: 15px;">
            <label for="level-select">Select Level: </label>
            <select id="level-select" style="padding: 5px;">
                <option value="A1">A1</option>
                <option value="A2">A2</option>
            </select>
        </div>

<div style="height: 180px; margin-bottom: 15px;">
    <img id="word-image" src="" style="max-height: 100%; border-radius: 8px; display: none;">
</div>

<div id="czech-word" class="display-czech">---</div>

        <div id="czech-word" class="display-czech">---</div>
        <div id="english-word" class="display-eng hidden">---</div>

        <button class="test-btn" onclick="getRandomWord()">Next Word</button>
        <button class="test-btn" style="background:#7f8c8d;" onclick="showTranslation()">Show Answer</button>
    </div>

    <nav>
        <a id="menu-home" href="../index.html">üè† Main Page</a>
    </nav>
</main>

<div id="footer-placeholder"></div>

<script>
    let db = null;

    // Load Database
    async function initDatabase() {
        try {
            const sqlPromise = initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
            const response = await fetch("czech_master.db");
            if (!response.ok) throw new Error("Database file czech_master.db not found!");
            
            const buf = await response.arrayBuffer();
            const [SQL, data] = await Promise.all([sqlPromise, buf]);
            db = new SQL.Database(new Uint8Array(data));
            console.log("Database connected!");
        } catch (err) {
            console.error(err);
            document.getElementById('czech-word').innerText = "Error loading DB";
        }
    }

function getRandomWord() {
    if (!db) return;
    const selectedLevel = document.getElementById('level-select').value;
    
    try {
        const res = db.exec("SELECT * FROM words");
        if (res.length > 0) {
            const cols = res[0].columns;
            const rows = res[0].values;

            // 1. Find indices for the new columns
            const lIdx = cols.findIndex(c => c.toLowerCase() === 'lemma');
            const tIdx = cols.findIndex(c => c.toLowerCase() === 'trans_en');
            const vIdx = cols.findIndex(c => c.toLowerCase() === 'level');
            const iIdx = cols.findIndex(c => c.toLowerCase() === 'image_path'); // NEW
            const aIdx = cols.findIndex(c => c.toLowerCase() === 'audio_path'); // NEW

            // 2. Filter
            const filtered = rows.filter(r => String(r[vIdx]).trim() === selectedLevel);

            if (filtered.length > 0) {
                const randomRow = filtered[Math.floor(Math.random() * filtered.length)];
                
                // 3. Update Text
                document.getElementById('czech-word').innerText = randomRow[lIdx];
                document.getElementById('english-word').innerText = randomRow[tIdx];
                document.getElementById('english-word').classList.add('hidden');

                // 4. Update Image Logic
                const imgElement = document.getElementById('word-image');
                const imgPath = randomRow[iIdx]; 
                
                if (imgPath && imgPath !== "") {
                    // We use ../ to go from /exercise folder back to root where /images is
                    imgElement.src = "../" + imgPath; 
                    imgElement.style.display = "inline-block";
                } else {
                    imgElement.style.display = "none";
                }

                // 5. Audio Auto-Play (Optional)
                const audioPath = randomRow[aIdx];
                if (audioPath && audioPath !== "") {
                    let audio = new Audio("../" + audioPath);
                    audio.play();
                }
            }
        }
    } catch (e) {
        console.error(e);
    }
}


    function showTranslation() {
        document.getElementById('english-word').classList.remove('hidden');
    }

    initDatabase();

    // Footer Loader
    fetch("/footer.html")
        .then(response => response.text())
        .then(data => { document.getElementById("footer-placeholder").innerHTML = data; })
        .catch(error => console.error("Error loading footer:", error));
</script>

<script src="js/translations.js"></script>
<script src="js/language-selector.js"></script>

</body>
</html>