<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="../scripts-header.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    
    <title>Advanced Teacher Dashboard | H√°CZech</title>

    <style>
        .admin-container { max-width: 1100px; margin: 20px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #user-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        #user-table th, #user-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        #user-table th { background:#2c3e50; color: white; cursor: pointer; position: sticky; top: 0; }
        #user-table tr:hover { background: #f1f1f1; }
        
        .report-card { background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 20px; }
        .matrix-table { width: 100%; border-collapse: collapse; background: white; }
        .matrix-table td, .matrix-table th { border: 1px solid #eee; padding: 8px; text-align: center; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .search-bar { flex: 2; padding: 10px; border: 2px solid #2c3e50; border-radius: 8px; }
        .filter-select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        
        .btn-reset { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .btn-reset:hover { background: #c0392b; }
        #access-denied { display: none; text-align: center; margin-top: 100px; color: #e74c3c; }

        /* Style for the new Breakdown Matrix */
        .group-row { background: #ecf0f1; font-weight: bold; text-align: left !important; }
        .page-row td:first-child { color: #7f8c8d; padding-left: 25px; text-align: left !important; }
    </style>
</head>
<body>

<div id="access-denied">
    <h1>Restricted Access</h1>
    <p>You do not have permission to view this page.</p>
    <a href="../index.html">Return to Home</a>
</div>

<div id="admin-content" style="display:none;">
    <div class="admin-container">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Teacher Console</h2>
            <div style="display:flex; gap:10px;">
                <button class="test-btn" style="background:#e67e22;" onclick="resetAllStats()">Reset All Students Time</button>
                <button class="test-btn" onclick="location.href='../index.html'">Main Page</button>
            </div>
        </header>

        <div class="controls">
            <input type="text" id="user-search" class="search-bar" placeholder="Search by name or email..." onkeyup="processUsers()">
            <select id="filter-status" class="filter-select" onchange="processUsers()">
                <option value="all">All Status</option>
                <option value="paid">Paid Only</option>
                <option value="pending">Pending Only</option>
            </select>
        </div>

        <table id="user-table">
            <thead>
                <tr>
                    <th onclick="setSort('name')">Name ‚Üï</th>
                    <th onclick="setSort('email')">Email ‚Üï</th>
                    <th onclick="setSort('totalSeconds')">Total Usage ‚Üï</th> 
                    <th>Paid Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="user-tbody"></tbody>
        </table>

        <div id="report-section" style="display:none; margin-top:40px; border-top:5px solid #2c3e50; padding-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="report-title" style="margin:0;">Student Progress</h3>
                <button class="test-btn" style="background:#7f8c8d;" onclick="document.getElementById('report-section').style.display='none'">Close Report</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="report-card">
                    <h4>Time Development (Last 14 Days)</h4>
                    <canvas id="timeChart" height="200"></canvas>
                </div>
                
                <div class="report-card">
                    <h4>Activity Breakdown (Group | Page)</h4>
                    <div id="matrix-container"></div>
                </div>
            </div>

            <div class="report-card" style="background: #fffafa;">
                <h4>Top Mistakes (Study Tool)</h4>
                <table class="matrix-table">
                    <thead>
                        <tr style="background:#eee;"><th>Czech Word</th><th>Mistakes Count</th><th>Current Weight</th></tr>
                    </thead>
                    <tbody id="mistake-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const auth = firebase.auth();
    const dbRef = firebase.database();
    let allUsersRaw = {};
    let sortField = 'name';
    let sortAsc = true;
    let myChartInstance = null;

    auth.onAuthStateChanged(user => {
        if (user && user.email === 'lukas@hackczech.com') {
            document.getElementById('admin-content').style.display = 'block';
            loadData();
        } else {
            document.getElementById('access-denied').style.display = 'block';
        }
    });

    function loadData() {
        dbRef.ref('users').on('value', snap => {
            allUsersRaw = snap.val() || {};
            processUsers();
        });
    }

    function setSort(field) {
        if (sortField === field) sortAsc = !sortAsc;
        else { sortField = field; sortAsc = true; }
        processUsers();
    }

    function processUsers() {
        const searchTerm = document.getElementById('user-search').value.toLowerCase();
        const filterVal = document.getElementById('filter-status').value;
        let usersArray = [];

        for (let id in allUsersRaw) {
            let u = allUsersRaw[id];
            let totalSecs = 0;
            
            // NEW TRACKER: Sum detailed_usage
            if (u.detailed_usage) {
                Object.values(u.detailed_usage).forEach(day => {
                    Object.values(day).forEach(group => {
                        Object.values(group).forEach(val => totalSecs += val);
                    });
                });
            }
            // LEGACY TRACKER: Sum old usage node if it exists
            if (u.usage) {
                Object.values(u.usage).forEach(day => {
                    Object.values(day).forEach(val => totalSecs += val);
                });
            }

            usersArray.push({ id, ...u, totalSeconds: totalSecs });
        }

        usersArray = usersArray.filter(u => {
            const matchesSearch = (u.name || '').toLowerCase().includes(searchTerm) || u.email.toLowerCase().includes(searchTerm);
            const matchesStatus = filterVal === 'all' || u.status === filterVal;
            return matchesSearch && matchesStatus;
        });

        usersArray.sort((a, b) => {
            let valA = a[sortField] || 0;
            let valB = b[sortField] || 0;
            if (typeof valA === 'string') return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return sortAsc ? valA - valB : valB - valA;
        });

        renderTable(usersArray);
    }

    function renderTable(users) {
        const tbody = document.getElementById('user-tbody');
        tbody.innerHTML = '';
        users.forEach(u => {
            const isPaid = u.status === 'paid';
            const mins = Math.floor(u.totalSeconds / 60);
            tbody.innerHTML += `
                <tr>
                    <td><strong>${u.name || 'N/A'}</strong></td>
                    <td>${u.email}</td>
                    <td>${mins} min</td>
                    <td>
                        <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="togglePaidStatus('${u.id}', this.checked)">
                        <span style="color:${isPaid?'#27ae60':'#e67e22'}">${u.status || 'pending'}</span>
                    </td>
                    <td>
                        <button class="test-btn" style="background:#3498db; padding:5px;" onclick="showReport('${u.id}')">Report</button>
                        <button class="btn-reset" onclick="resetUserStats('${u.id}')">Reset</button>
                    </td>
                </tr>`;
        });
    }

    function showReport(uid) {
        const u = allUsersRaw[uid];
        document.getElementById('report-section').style.display = 'block';
        document.getElementById('report-title').innerText = "Progress: " + (u.name || u.email);
        document.getElementById('report-section').scrollIntoView({ behavior: 'smooth' });

        // 1. New Detailed Activity Matrix
        const detailed = u.detailed_usage || {};
        let summary = {};
        
        // Collate all pages into categories
        Object.values(detailed).forEach(day => {
            for (let group in day) {
                if (!summary[group]) summary[group] = { total: 0, pages: {} };
                for (let page in day[group]) {
                    let time = day[group][page];
                    summary[group].pages[page] = (summary[group].pages[page] || 0) + time;
                    summary[group].total += time;
                }
            }
        });

        let matrixHtml = `<table class="matrix-table">
            <thead><tr><th>Category / Page</th><th>Total Time</th></tr></thead><tbody>`;

        for (let group in summary) {
            matrixHtml += `<tr class="group-row"><td>üìÅ ${group}</td><td>${Math.floor(summary[group].total/60)}m</td></tr>`;
            for (let page in summary[group].pages) {
                let s = summary[group].pages[page];
                matrixHtml += `<tr class="page-row"><td>‚îî ${page}</td><td>${Math.floor(s/60)}m ${s%60}s</td></tr>`;
            }
        }
        
        if (Object.keys(summary).length === 0) matrixHtml += `<tr><td colspan="2">No detailed logs found.</td></tr>`;
        document.getElementById('matrix-container').innerHTML = matrixHtml + `</tbody></table>`;

        // 2. Time Development Chart (Last 14 Days)
        const last14 = [];
        for(let i=13; i>=0; i--) {
            let d = new Date(); d.setDate(d.getDate() - i);
            last14.push(d.toISOString().split('T')[0]);
        }
        
        const chartData = last14.map(date => {
            let dayTotal = 0;
            // From Detailed Node
            if (u.detailed_usage && u.detailed_usage[date]) {
                Object.values(u.detailed_usage[date]).forEach(group => {
                    Object.values(group).forEach(t => dayTotal += t);
                });
            }
            // From Legacy Node
            if (u.usage && u.usage[date]) {
                Object.values(u.usage[date]).forEach(t => dayTotal += t);
            }
            return dayTotal / 60;
        });

        renderChart(last14, chartData);

        // 3. Mistakes Table
        const mBody = document.getElementById('mistake-tbody');
        mBody.innerHTML = '';
            console.log("Mistakes data for this user:", u.mistakes);

        if (u.mistakes) {
            Object.entries(u.mistakes).sort((a,b) => b[1] - a[1]).slice(0, 10).forEach(([word, count]) => {
                mBody.innerHTML += `<tr><td>${word}</td><td style="color:red; font-weight:bold;">${count}</td><td>${(u.weights||{})[word] || 5}</td></tr>`;
            });
        } else {
            mBody.innerHTML = '<tr><td colspan="3">No mistakes recorded yet.</td></tr>';
        }
    }

    function renderChart(labels, data) {
        const ctx = document.getElementById('timeChart').getContext('2d');
        if (myChartInstance) myChartInstance.destroy();
        myChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Minutes Active', data: data, borderColor: '#3498db', tension: 0.2, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.1)' }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    function resetUserStats(uid) {
        if(confirm("Reset usage time for this student? (Weights and Mistakes remain)")) {
            dbRef.ref(`users/${uid}/detailed_usage`).remove();
            dbRef.ref(`users/${uid}/usage`).remove();
        }
    }

    function resetAllStats() {
        if(confirm("Reset time stats for ALL students? This cannot be undone.")) {
            Object.keys(allUsersRaw).forEach(uid => {
                dbRef.ref(`users/${uid}/detailed_usage`).remove();
                dbRef.ref(`users/${uid}/usage`).remove();
            });
        }
    }

    function togglePaidStatus(uid, isChecked) {
        dbRef.ref(`users/${uid}`).update({ status: isChecked ? 'paid' : 'pending' });
    }
</script>
</body>
</html>